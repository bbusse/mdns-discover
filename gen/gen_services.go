// SPDX-License-Identifier: BSD-3-Clause
//
// mdns-discover - services file generator
//
// Copyright (c) 2023-2025 Björn Busse
// Author: Björn Busse
// Contributors:
//
// This utility reads data/*.txt and emits services.go.
// Licensed under the BSD 3-Clause License; see LICENSE for details.
package main

import (
	"bufio"
	"fmt"
	"os"
	"strings"
)

func readLines(path string) ([]string, error) {
	file, err := os.Open(path)
	if err != nil {
		return nil, err
	}
	defer file.Close()

	var lines []string
	scanner := bufio.NewScanner(file)
	for scanner.Scan() {
		lines = append(lines, scanner.Text())
	}
	return lines, scanner.Err()
}

// Include files from data directory
func main() {
	data_path := "data"
	file_suffix := ".txt"
	fs, err := os.ReadDir(data_path)
	if err != nil {
		fmt.Fprintf(os.Stderr, "error: cannot read dir %s: %v\n", data_path, err)
		os.Exit(1)
	}
	out, err := os.Create("services.go")
	if err != nil {
		fmt.Fprintf(os.Stderr, "error: cannot create services.go: %v\n", err)
		os.Exit(1)
	}
	// Write generated header
	header := `// SPDX-License-Identifier: BSD-3-Clause
//
// mdns-discover - generated services list (aggregated from data/*.txt)
// Code generated by gen/gen_services.go; DO NOT EDIT.
//
// Source data files: data/*.txt
// License: BSD 3-Clause (see LICENSE)

package main

var services = [...]string{
`
	if _, err := out.Write([]byte(header)); err != nil {
		fmt.Fprintf(os.Stderr, "error: write header: %v\n", err)
		os.Exit(1)
	}

	for _, f := range fs {
		if file_suffix != "" && !strings.HasSuffix(f.Name(), file_suffix) {
			continue
		}

		lines, err := readLines(data_path + "/" + f.Name())
		if err != nil {
			fmt.Printf("Failed to read file: %s", err)
		}

		for _, line := range lines {
			if _, err := out.Write([]byte("    \x22" + line + "\x22,\n")); err != nil {
				fmt.Fprintf(os.Stderr, "error: write line %s: %v\n", line, err)
				os.Exit(1)
			}
		}
	}
	if _, err := out.Write([]byte("}\n")); err != nil {
		fmt.Fprintf(os.Stderr, "error: write footer: %v\n", err)
		os.Exit(1)
	}
}
